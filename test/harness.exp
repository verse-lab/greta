#!/usr/bin/expect -f

# Set timeout for expect commands (adjust as needed)
set timeout 30

set base_grammar_file [lindex $argv 0]

# CLI application command (replace with actual command)
proc get_cli_command {path} {
    set binary_exec "dune exec -- ../bin/main.exe"
    global base_grammar_file
    set grammar_extension ".mly"
    set conflicts_extension ".conflicts"
    set config_extension ".cfg"

    # set grammar_file "$base_grammar_file\_"
    # foreach choice $path {
    #     set grammar_file "$grammar_file$choice"
    # }

    # exec cp "$base_grammar_file$grammar_extension" "$grammar_file$grammar_extension"
    set cli_command "$binary_exec $base_grammar_file$grammar_extension $base_grammar_file$conflicts_extension $base_grammar_file$config_extension"

    return [list $cli_command $base_grammar_file$grammar_extension]
}

# File to store results
set results_file "test_results.csv"

# Function to rerun the CLI application with a given path
proc rerun_path {path spawn_id} {
    global cli_command

    foreach choice $path {
        if {[catch {
            expect {
                -re {Choose your preference!.*Option 0:.*Option 1:.*} {
                    exp_send "$choice\r"
                }
                timeout {
                    puts "Timeout while sending choice $choice"
                    return "TIMEOUT"
                }
                eof {
                    puts "Unexpected end of file while sending choice $choice"
                    return "EOF"
                }
            }
        } err]} {
            puts "Error during expect: $err"
            return "EXPECT_ERROR"
        }
    }
    return "SUCCESS"
}

# Procedure to handle choices and record paths
proc handle_choice {current_path next} {
    
    set current_path [lappend current_path $next]
    set output [get_cli_command $current_path]
    set cli_command [lindex $output 0]
    set grammar_file [lindex $output 1]

    spawn {*}$cli_command
    
    set result [rerun_path $current_path $spawn_id]
    # if {$result == "SUCCESS"} {
    #     puts "Path: $current_path, $result"
    # } else {
    #     puts "Error occurred. Path: $current_path, $result"
    #     return
    # }
    
    expect {
        -re {Choose your preference!.*Option 0:.*Option 1:.*} {
            # kill the process
            # exp_send "\x03"; close;
            # exec rm $grammar_file

            # Record path for option 0
            handle_choice $current_path 0

            # Record path for option 1
            handle_choice $current_path 1
        }
        -re {(Final result:.*)} {
            set result $expect_out(1,string)
            puts "Path: $current_path, $result"
            exec echo "$current_path,$result" >> $::results_file
        }
        timeout {
            puts "Timeout occurred. Path: $current_path"
            exec echo "$current_path,TIMEOUT" >> $::results_file
        }
        eof {
            puts "End of interaction reached. Path: $current_path"
            exec echo "$current_path,EOF" >> $::results_file
        }
    }
}

# Main script execution
puts "Starting CLI application testing..."
exec echo "Path,Result" > $results_file

handle_choice {} 0
handle_choice {} 1

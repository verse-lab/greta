#!/usr/bin/expect -f

# Set timeout for expect commands (adjust as needed)
set timeout 5

set base_grammar_file [lindex $argv 0]

# CLI application command (replace with actual command)
proc get_cli_command {path} {
    set binary_exec "dune exec -- ../bin/main.exe"
    global base_grammar_file
    set grammar_extension ".mly"
    set conflicts_extension ".conflicts"
    set config_extension ".cfg"
    set tree_extension ".trees"

    set cli_command "$binary_exec $base_grammar_file$grammar_extension $base_grammar_file$conflicts_extension $base_grammar_file$config_extension $base_grammar_file$tree_extension"
    return [list $cli_command $base_grammar_file$grammar_extension]
}

# File to store results
set results_file "test_results.csv"

# Function to rerun the CLI application with a given path
proc rerun_path {path spawn_id} {
    global cli_command

    foreach choice $path {
        if {[catch {
            expect {
                -re {Choose your preference!.*Option 0:.*Option 1:.*} {
                    sleep 0.2
                    exp_send "$choice\r"
                }
                timeout {
                    puts "Timeout while sending choice $choice"
                    return "TIMEOUT"
                }
                eof {
                    puts "Unexpected end of file while sending choice $choice"
                    return "EOF"
                }
            }
        } err]} {
            puts "Error during expect: $err, choice: $choice, path: $path"
            return "EXPECT_ERROR"
        }
    }
    return "SUCCESS"
}

# Procedure to handle choices and record paths
proc handle_choice {current_path next start} {
    
    set output [get_cli_command $current_path]
    set cli_command [lindex $output 0]
    set grammar_file [lindex $output 1]

    spawn {*}$cli_command
    
    puts "Path: $current_path"
    set result ""
    if {$start eq 0} {
        set current_path [lappend current_path $next]
        sleep 0.5
        set result [rerun_path $current_path $spawn_id]
    }
    set convert_time ""
    set learn_time ""
    set intersect_time ""
    
    expect {
        -re {There are no ambiguities} {
            set result "NO_CONFLICTS"
            exp_continue
        }
        -re {Choose your preference!.*Option 0:.*Option 1:.*} {
            # kill the process
            # exp_send "\x03"; close;
            # exec rm $grammar_file

            # Record path for option 0
            sleep 0.1
            handle_choice $current_path 0 0

            sleep 0.1
            handle_choice $current_path 1 0
        }
        -re {Time elapsed for converting TA: ([0-9.]+)} {
            set convert_time $expect_out(1,string)
            exp_continue
        }
        -re {Time elapsed for learning TA: ([0-9.]+)} {
            set learn_time $expect_out(1,string)
            exp_continue
        }
        -re {Time elapsed for intersecting TA: ([0-9.]+)} {
            set intersect_time $expect_out(1,string)
            exp_continue
        }
        -re {reported due to limitations of Menhir} {
            puts "Menhir limitation error. Path: $current_path"
            exec echo "$current_path,MENHIR_LIMITATION,,," >> $::results_file
        }
        -re {Fatal error:.*} {
            puts "Error occurred. Path: $current_path"
            exec echo "$current_path,ERROR,,," >> $::results_file
        }
        timeout {
            puts "Timeout occurred. Path: $current_path"
            exec echo "$current_path,TIMEOUT,,," >> $::results_file
        }
        eof {
            puts "End of interaction reached. Path: $current_path. Result: $result"
            if {$result eq "NO_CONFLICTS"} {
                exec echo "$current_path, NO_CONFLICTS" >> $::results_file
            }
            if {$result ne "NO_CONFLICTS"} {
                if {$result ne ""} {
                    # Write complete line with path, result and all timings
                    exec echo "$current_path,$result,$convert_time,$learn_time,$intersect_time" >> $::results_file
                }
            }
            # exec echo "$current_path,EOF" >> $::results_file
        }
    }
}

# Main script execution
puts "Starting CLI application testing..."
exec echo "Path,Result,Convert Time,Learn Time,Intersect Time" > $results_file

handle_choice {} 0 1

